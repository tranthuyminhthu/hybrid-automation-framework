name: Cypress Test and Deploy Custom Report to Vercel

on:
  schedule:
    - cron: '0 7 * * *'  # Ch·∫°y m·ªói ng√†y l√∫c 7h s√°ng UTC (14h Vi·ªát Nam)
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - 'cypress/custom-report/**'  # Kh√¥ng k√≠ch ho·∫°t n·∫øu ch·ªâ thay ƒë·ªïi file b√°o c√°o

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: C·∫•p quy·ªÅn th·ª±c thi cho script
        run: chmod +x run-cypress-conditionally.sh

      - name: Ki·ªÉm tra quy·ªÅn th·ª±c thi script
        run: ls -l run-cypress-conditionally.sh

      - name: Ch·∫°y Cypress test (cron: to√†n b·ªô, push: c√≥ ƒëi·ªÅu ki·ªán)
        continue-on-error: true
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "üïí Cron job: ch·∫°y to√†n b·ªô test"
            npm run test-and-report
          else
            echo "üöÄ Push: ki·ªÉm tra file thay ƒë·ªïi"
            bash ./run-cypress-conditionally.sh
          fi

      - name: Commit v√† push custom report
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add cypress/custom-report/index.html
          git commit -m "Update custom Cypress test report" || echo "No changes to commit"
          git push || echo "Push failed or no changes to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Thi·∫øt l·∫≠p Vercel URL
        run: echo "VERCEL_URL=https://hybrid-automation-framework.vercel.app" >> $GITHUB_ENV

      - name: G·ª≠i email v·ªõi link b√°o c√°o
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'Daily Custom Cypress Test Report - ${{ github.run_id }}'
          body: '\n\nD∆∞·ªõi ƒë√¢y l√† link b√°o c√°o test Cypress t√πy ch·ªânh h√¥m nay: ${{ env.VERCEL_URL }}\n\nTr√¢n tr·ªçng,\nThu Tran'
          to: 'duyvu2612003@gmail.com'
          from: 'Thu Tran <tranthuyminhthu0611@gmail.com>'